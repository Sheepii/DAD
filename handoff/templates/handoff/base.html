<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}DAD{% endblock %}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="bg-light">
    <style>
      @media (max-width: 991.98px) {
        .checklist-lg .form-check-input {
          width: 1.5rem;
          height: 1.5rem;
        }

        .checklist-lg .form-check-label {
          font-size: 1.05rem;
        }
      }

      .mockup-slot {
        cursor: pointer;
        transition: box-shadow 0.15s ease, border-color 0.15s ease;
      }

      .mockup-slot.mockup-required {
        border-color: #f0ad4e;
      }

      .mockup-slot.is-filled {
        border-color: #198754;
        box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.25);
      }

      .mockup-slot.dragover {
        border-color: #198754;
        box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.35);
      }

      .design-drop.dragover {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
      }

      .is-next {
        border-color: #0d6efd;
        background: rgba(13, 110, 253, 0.08);
      }

      .is-done {
        opacity: 0.6;
      }
    </style>
    <nav class="navbar navbar-expand-lg bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold" href="{% url 'handoff:today' %}{% if current_store %}?store={{ current_store.id }}{% endif %}">
          DAD - Design A Day
        </a>
        <div class="d-flex align-items-center gap-2">
          {% if store_options %}
            <div class="d-flex align-items-center gap-1">
              <label class="text-muted small" for="store-switcher">Store</label>
              <select class="form-select form-select-sm" id="store-switcher">
                <option value="">All</option>
                {% for store in store_options %}
                  <option value="{{ store.id }}" {% if current_store and store.id == current_store.id %}selected{% endif %}>
                    {{ store.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
          <a class="btn btn-outline-primary btn-sm" href="{% url 'handoff:summary' %}{% if current_store %}?store={{ current_store.id }}{% endif %}">
            Summary
          </a>
          <a class="btn btn-outline-primary btn-sm" href="{% url 'handoff:store_calendars' %}{% if current_store %}?store={{ current_store.id }}{% endif %}">
            Store calendars
          </a>
          <a class="btn btn-outline-info btn-sm" href="{% url 'handoff:sop_library' %}">
            SOPs
          </a>
          {% if request.user.is_staff %}
            <a class="btn btn-outline-secondary btn-sm" href="/admin/">Admin</a>
          {% endif %}
          {% if request.user.is_authenticated %}
            <span class="text-muted small">{{ request.user.get_username }}</span>
            <form method="post" action="{% url 'logout' %}" class="mb-0">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm">Logout</button>
            </form>
          {% else %}
            <a class="btn btn-primary btn-sm" href="{% url 'login' %}">Login</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div id="csrf-token" class="d-none">{% csrf_token %}</div>
      {% if runway and runway.below_threshold %}
        <div class="alert {% if runway.days_remaining == 0 %}alert-danger{% else %}alert-warning{% endif %}">
          {% if current_store %}{{ current_store.name }} runway low:{% else %}Runway low:{% endif %}
          {{ runway.days_remaining }} day{% if runway.days_remaining != 1 %}s{% endif %} remaining
          {% if runway.exhaustion_date %}(last date {{ runway.exhaustion_date|date:"M j, Y" }}){% endif %}.
        </div>
      {% endif %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
      {% block content %}{% endblock %}
    </main>

    <script>
      document.body.addEventListener("htmx:configRequest", (event) => {
        const token = document.querySelector(
          'input[name="csrfmiddlewaretoken"]'
        );
        if (token) {
          event.detail.headers["X-CSRFToken"] = token.value;
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const selector = document.getElementById("store-switcher");
        if (!selector) return;
        selector.addEventListener("change", () => {
          const url = new URL(window.location.href);
          if (selector.value) {
            url.searchParams.set("store", selector.value);
          } else {
            url.searchParams.delete("store");
          }
          window.location.href = url.toString();
        });
      });
    </script>

    <script>
      function bindMockupSlots() {
        document.querySelectorAll(".mockup-slot").forEach((slot) => {
          const input = slot.querySelector(".mockup-input");
          if (!input) return;

          const upload = (file) => {
            if (!file) return;
            const slotId = slot.dataset.slotId;
            const formData = new FormData();
            formData.append("mockup_file", file);
            const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
            fetch(`/mockup/${slotId}/upload/`, {
              method: "POST",
              headers: csrf ? { "X-CSRFToken": csrf.value } : {},
              body: formData,
            })
              .then((response) => response.text())
              .then((html) => {
                slot.outerHTML = html;
                bindMockupSlots();
                const stepsPanel = document.getElementById("steps-panel");
                if (stepsPanel) {
                  const taskId = stepsPanel.dataset.taskId;
                  fetch(`/task/${taskId}/steps/`)
                    .then((response) => response.text())
                    .then((stepsHtml) => {
                      stepsPanel.innerHTML = stepsHtml;
                    });
                  fetch(`/task/${taskId}/mockups/`)
                    .then((response) => response.text())
                    .then((mockupsHtml) => {
                      const panel = document.getElementById("mockups-panel");
                      if (panel) {
                        panel.outerHTML = mockupsHtml;
                        bindMockupSlots();
                      }
                    });
                }
              });
          };

          slot.addEventListener("click", (event) => {
            const target = event.target;
            if (target && target.closest && target.closest("a,button,input,select,textarea,label")) {
              return;
            }
            input.click();
          });
          input.addEventListener("change", (event) => {
            upload(event.target.files[0]);
          });
          slot.addEventListener("dragover", (event) => {
            event.preventDefault();
            slot.classList.add("dragover");
          });
          slot.addEventListener("dragleave", () => {
            slot.classList.remove("dragover");
          });
          slot.addEventListener("drop", (event) => {
            event.preventDefault();
            slot.classList.remove("dragover");
            const file = event.dataTransfer.files[0];
            upload(file);
          });
        });
      }

      document.addEventListener("DOMContentLoaded", bindMockupSlots);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("design-upload-form");
        if (!form) return;
        const input = form.querySelector('input[type="file"]');
        form.classList.add("design-drop");
        const progress = document.getElementById("design-upload-progress");
        const bar = progress ? progress.querySelector(".progress-bar") : null;
        form.addEventListener("dragover", (event) => {
          event.preventDefault();
          form.classList.add("dragover");
        });
        form.addEventListener("dragleave", () => {
          form.classList.remove("dragover");
        });
        form.addEventListener("drop", (event) => {
          event.preventDefault();
          form.classList.remove("dragover");
          const file = event.dataTransfer.files[0];
          if (!file) return;
          input.files = event.dataTransfer.files;
          submitWithProgress(form, progress, bar);
        });
        form.addEventListener("submit", (event) => {
          event.preventDefault();
          submitWithProgress(form, progress, bar);
        });
      });

      function submitWithProgress(form, progress, bar) {
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput || !fileInput.files.length) return;
        const action = form.getAttribute("action");
        const formData = new FormData(form);
        if (progress) progress.classList.remove("d-none");
        if (bar) bar.style.width = "0%";

        const xhr = new XMLHttpRequest();
        xhr.open("POST", action, true);
        xhr.upload.onprogress = (event) => {
          if (!event.lengthComputable) return;
          const percent = Math.round((event.loaded / event.total) * 100);
          if (bar) bar.style.width = percent + "%";
        };
        xhr.onload = () => {
          if (progress) progress.classList.add("d-none");
          if (xhr.status >= 200 && xhr.status < 400) {
            window.location.reload();
          } else {
            const message = xhr.responseText ? `Upload failed: ${xhr.responseText}` : "Upload failed. Please try again.";
            alert(message);
          }
        };
        xhr.onerror = () => {
          if (progress) progress.classList.add("d-none");
          alert("Upload failed. Please try again.");
        };
        xhr.send(formData);
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.getElementById("toggle-completed-steps");
        const list = document.getElementById("checklist-items");
        if (!toggle || !list) return;
        let hidden = false;
        toggle.addEventListener("click", () => {
          hidden = !hidden;
          list.querySelectorAll(".is-done").forEach((item) => {
            item.style.display = hidden ? "none" : "flex";
          });
          toggle.textContent = hidden ? "Show completed" : "Hide completed";
        });
        const next = list.querySelector(".is-next");
        if (next) {
          next.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const getCookie = (name) => {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) {
            return parts.pop().split(";").shift();
          }
          return null;
        };

        const form = document.getElementById("mockup-generate-form");
        if (!form) return;
        const statusEl = document.getElementById("mockup-generate-status");
        const barEl = document.getElementById("mockup-generate-bar");
        const textEl = document.getElementById("mockup-generate-text");
        const button = form.querySelector('button[type="submit"]');
        const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
        const taskId = form.dataset.taskId;

        const refreshMockups = async () => {
          const panel = document.getElementById("mockups-panel");
          if (!panel || !taskId) return;
          const resp = await fetch(`/task/${taskId}/mockups/`, { credentials: "same-origin" });
          const html = await resp.text();
          panel.outerHTML = html;
          bindMockupSlots();
        };

        const updateProgress = (done, total) => {
          if (!barEl || !textEl) return;
          if (total > 0) {
            const percent = Math.min(100, Math.round((done / total) * 100));
            barEl.style.width = percent + "%";
            barEl.setAttribute("aria-valuenow", String(percent));
            textEl.textContent = `Generating ${done} of ${total} mockups...`;
          } else {
            barEl.style.width = "100%";
            barEl.setAttribute("aria-valuenow", "100");
            textEl.textContent = "Generating mockups...";
          }
        };

        const pollStatus = async (jobId) => {
          try {
            const res = await fetch(
              `/task/${taskId}/mockups/progress/?job=${jobId}`,
              {
                headers: { Accept: "application/json" },
                credentials: "same-origin",
              }
            );
            if (!res.ok) {
              throw new Error("progress");
            }
            const payload = await res.json();
            if (payload.status === "error") {
              if (textEl) {
                textEl.textContent = payload.error || "Mockup generation failed.";
              }
              if (button) button.disabled = false;
              return;
            }
            updateProgress(payload.done || 0, payload.total || 0);
            if (payload.status === "done") {
              if (textEl) textEl.textContent = "Mockups generated.";
              if (button) button.disabled = false;
              await refreshMockups();
              return;
            }
          } catch (err) {
            if (textEl) textEl.textContent = "Checking progress...";
          }
          setTimeout(() => pollStatus(jobId), 1000);
        };

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (button && button.disabled) return;
          if (statusEl) statusEl.classList.remove("d-none");
          updateProgress(0, 0);
          if (button) button.disabled = true;

          const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]');
          const formData = new FormData(form);
          try {
          const csrfToken = (csrfInput && csrfInput.value) || getCookie("csrftoken");
          const res = await fetch(form.action, {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              Accept: "application/json",
              ...(csrfToken ? { "X-CSRFToken": csrfToken } : {}),
            },
            body: formData,
          });
            if (!res.ok) {
              const errText = await res.text();
              if (textEl) {
                textEl.textContent = errText || "Mockup generation failed.";
              }
              if (button) button.disabled = false;
              return;
            }
            const payload = await res.json();
            if (!payload.job_id) {
              if (textEl) textEl.textContent = "Unable to start generation.";
              if (button) button.disabled = false;
              return;
            }
            updateProgress(0, payload.total || 0);
            pollStatus(payload.job_id);
          } catch (err) {
            if (textEl) textEl.textContent = "Mockup generation failed.";
            if (button) button.disabled = false;
          }
        });
      });
    </script>

    {% if active_sop %}
      <button
        class="btn btn-primary btn-sm position-fixed"
        style="right: 24px; bottom: 24px; z-index: 1045;"
        data-bs-toggle="offcanvas"
        data-bs-target="#sopSidebar"
        aria-controls="sopSidebar"
      >
        Need Help?
      </button>

      <div
        class="offcanvas offcanvas-end"
        tabindex="-1"
        id="sopSidebar"
        aria-labelledby="sopSidebarLabel"
        style="width: min(540px, 92vw);"
      >
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="sopSidebarLabel">{{ active_sop.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
          <iframe
            src="{{ active_sop_embed_url }}"
            style="width: 100%; height: 100%; min-height: 70vh; border: 0;"
            allowfullscreen
            loading="lazy"
          ></iframe>
        </div>
      </div>
    {% endif %}

  </body>
</html>
