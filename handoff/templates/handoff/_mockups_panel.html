{% load handoff_extras %}
<div id="mockups-panel">
  <h5 class="card-title">Mockups</h5>
  <div class="text-muted small mb-2">
    Click a mockup image or static slide to download it.
  </div>
  <div class="mb-3">
    <a
      class="btn btn-primary btn-sm me-2 mockup-zip-download-btn"
      href="{% url 'handoff:download_mockups' task.id %}"
      data-zip-label="Download ZIP"
      data-zip-loading-label="Preparing download…"
    >
      <span
        class="spinner-border spinner-border-sm me-1 visually-hidden mockup-zip-download-spinner"
        role="status"
        aria-hidden="true"
      ></span>
      <span class="mockup-zip-download-text">Download ZIP</span>
    </a>
  </div>
  <div class="row g-2">
    {% for card in mockup_cards %}
      <div class="col-6 col-md-4 col-lg-3">
        {% if card.kind == "slot" %}
          {% include "handoff/_mockup_slot.html" with slot=card.slot fallback_image_id=card.fallback_image_id required_orders=required_orders %}
        {% else %}
          {% with extra=card.extra %}
            <div class="border rounded p-2 h-100">
              {% if extra.is_video %}
                <video
                  controls
                  class="w-100 rounded mb-2"
                  style="background: #000; aspect-ratio: 1/1; object-fit: cover;"
                  preload="metadata"
                >
                  <source src="{% url 'handoff:mockup_file_download' extra.drive_file_id %}" />
                </video>
              {% else %}
                <a
                  href="{% url 'handoff:mockup_file_download' extra.drive_file_id %}"
                  download="{{ extra.filename }}"
                  class="d-block text-decoration-none"
                >
                  <img
                    src="https://drive.google.com/thumbnail?id={{ extra.drive_file_id }}&sz=w300"
                    alt="{{ extra.label }}"
                    class="img-fluid rounded mb-2"
                    style="background: #000; object-fit: cover; display: block;"
                    loading="lazy"
                  />
                </a>
              {% endif %}
              <div class="small fw-semibold">
                {{ extra.label }}
                <span class="badge bg-secondary ms-1">Static</span>
              </div>
              <div class="text-muted small">{{ extra.filename }}</div>
              {% if not extra.include_in_mockup_zip %}
                <div class="small">
                  <span class="badge bg-warning text-dark">Visible only</span>
                </div>
              {% endif %}
            </div>
          {% endwith %}
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>
<script>
  (function () {
    const panel = document.getElementById("mockups-panel");
    if (!panel) return;
    panel.querySelectorAll(".mockup-zip-download-btn").forEach((btn) => {
      const spinner = btn.querySelector(".mockup-zip-download-spinner");
      const textEl = btn.querySelector(".mockup-zip-download-text");
      const loadingLabel =
        btn.dataset.zipLoadingLabel || btn.dataset.zipLabel || "Preparing download…";
      btn.addEventListener("click", (event) => {
        if (btn.dataset.zipLoading === "1") {
          event.preventDefault();
          return;
        }
        btn.dataset.zipLoading = "1";
        btn.classList.add("disabled");
        btn.setAttribute("aria-busy", "true");
        if (spinner) {
          spinner.classList.remove("visually-hidden");
        }
        if (textEl) {
          textEl.textContent = loadingLabel;
        }
      });
    });
  })();
</script>
