{% extends "admin/base_site.html" %}
{% load i18n %}

{% block content %}
  <div class="notes-page">
    <header class="notes-header">
      <h1>Admin Notes</h1>
      <p class="notes-callout">Save quick thoughts for the team or yourself.</p>
    </header>

    <style>
      .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.25rem;
      }
      @media (min-width: 1200px) {
        .notes-grid {
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
      }
      :root {
        --notes-surface: #0f0f0f;
        --notes-card: #1b1b1b;
        --notes-border: rgba(255, 255, 255, 0.08);
        --notes-faint: rgba(255, 255, 255, 0.4);
      }
      .notes-folders-panel {
        background: var(--notes-surface);
        border: 1px solid var(--notes-border);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
      }
      .folders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-top: 0.75rem;
      }
      .folder-card {
        border: 1px solid var(--notes-border);
        border-radius: 0.5rem;
        padding: 0.75rem;
        background: var(--notes-card);
        color: #f5f5f5;
      }
      .folder-card strong {
        display: block;
        margin-bottom: 0.25rem;
      }
      .folder-counts {
        font-size: 0.8rem;
        color: var(--notes-faint);
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .note-card-actions {
        margin-top: 0.75rem;
        display: flex;
        justify-content: flex-end;
      }
      .note-card-actions form {
        margin: 0;
      }
      .note-card-actions button {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .note-archived-badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        border-radius: 999px;
        background: #4f4f4f;
        color: #fff;
        margin-left: 0.25rem;
      }
      .note-folder-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        background: #2a2a40;
        color: #aacfef;
        margin-left: 0.35rem;
      }
      .notes-section-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .notes-section-heading h2 {
        margin: 0;
      }
      .notes-archived-header {
        margin-top: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .notes-archived-header h2 {
        margin: 0;
      }
      .notes-archived-hint {
        font-size: 0.85rem;
        color: var(--notes-faint);
      }
    </style>

    <section class="notes-folders-panel">
      <div class="notes-section-heading">
        <h2>Folders</h2>
        <p class="notes-archived-hint">Create quick buckets to organize notes before archiving.</p>
      </div>
      <form method="post" class="folder-form" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="create_folder" />
        <input type="hidden" name="next" value="{{ request.path }}" />
        <div class="note-form-field">
          <label for="folder-name-input">New folder name</label>
          <input
            id="folder-name-input"
            name="folder_name"
            type="text"
            class="textinput"
            placeholder="Idea, Reference, Approved"
            required
          />
        </div>
        <button type="submit" class="default">Create folder</button>
      </form>
      {% if folders %}
        <div class="folders-grid">
          {% for folder in folders %}
            <div class="folder-card">
              <strong>{{ folder.name }}</strong>
              <div class="folder-counts">
                <span>{{ folder.active_count }} active</span>
                <span>{{ folder.archived_count }} archived</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="note-empty" style="margin:0.5rem 0 0;">No folders yet.</p>
      {% endif %}
    </section>

    <section class="notes-form-card" style="background: var(--notes-card); border: 1px solid var(--notes-border); border-radius:0.75rem; padding:1rem; margin-bottom:1.5rem;">
      <form method="post" enctype="multipart/form-data" novalidate id="admin-note-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="note-form-field">
          {{ form.title.label_tag }}
          {{ form.title }}
          {% if form.title.errors %}
            <p class="note-error">{{ form.title.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="note-form-field">
          {{ form.body.label_tag }}
          {{ form.body }}
          {% if form.body.errors %}
            <p class="note-error">{{ form.body.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="note-form-field">
          {{ form.folder.label_tag }}
          {{ form.folder }}
          {% if form.folder.errors %}
            <p class="note-error">{{ form.folder.errors.0 }}</p>
          {% endif %}
        </div>
        <div class="note-form-field">
          <label for="note-images-input">Images</label>
          {{ form.images }}
          <div id="note-paste-zone" class="note-paste-zone" tabindex="0">
            <div><strong>Paste images with Ctrl+V</strong> or drag and drop them here.</div>
            <div class="text-muted small">You can also pick files from your computer.</div>
            <button type="button" class="button" id="note-images-browse">Choose files</button>
          </div>
          <div id="note-image-preview-list" class="note-image-preview-list"></div>
        </div>
        <button type="submit" class="default">Save note</button>
      </form>
    </section>

    <section class="notes-list">
      <div class="notes-section-heading">
        <h2>Active notes</h2>
        <p class="notes-archived-hint">Archive updates when they are done; they stay visible below.</p>
      </div>
      {% if notes %}
        <div class="notes-grid">
          {% for note in notes %}
            <article class="note-card note-card-clickable" tabindex="0" role="button" aria-label="Open note">
              <div class="note-card-content">
                <header class="note-card-header">
                  <div class="note-card-title">
                    {{ note.title|default:"Untitled note" }}
                    {% if note.folder %}
                      <span class="note-folder-badge">{{ note.folder.name }}</span>
                    {% endif %}
                  </div>
                  <span class="note-meta">
                    {{ note.created_at|date:"M d, Y H:i" }}
                    {% if note.author %}· {{ note.author.get_username }}{% endif %}
                  </span>
                </header>
                <div class="note-body">{{ note.body|linebreaksbr }}</div>
                {% if note.images.all %}
                  <div class="note-image-grid">
                    {% for image in note.images.all %}
                      <button
                        type="button"
                        class="note-image-btn"
                        data-full="https://drive.google.com/uc?export=view&id={{ image.drive_file_id }}"
                        data-caption="{{ image.filename|default:'Note image' }}"
                        title="Click to zoom"
                      >
                        <span class="note-image-tile">
                          <img
                            src="https://drive.google.com/thumbnail?id={{ image.drive_file_id }}&sz=w800"
                            alt="{{ image.filename|default:'Note image' }}"
                            loading="lazy"
                          />
                        </span>
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="note-card-actions">
                  <form method="post" class="note-action-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="archive" />
                    <input type="hidden" name="note_id" value="{{ note.id }}" />
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <button
                      type="submit"
                      class="default"
                      onclick="event.stopPropagation();"
                      title="Archive this note"
                    >
                      Archive
                    </button>
                  </form>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="note-empty">
          <p>{% translate "No notes yet." %}</p>
        </div>
      {% endif %}
    </section>

    {% if archived_notes %}
      <section class="notes-archived">
        <div class="notes-archived-header">
          <h2>Archived notes</h2>
          <span class="notes-archived-hint">Restoring a note brings it back to the active list.</span>
        </div>
        <div class="notes-grid">
          {% for note in archived_notes %}
          <article class="note-card note-card-clickable" tabindex="0" role="button" aria-label="Open note">
            <div class="note-card-content">
              <header class="note-card-header">
                <div class="note-card-title">
                  {{ note.title|default:"Untitled note" }}
                  {% if note.folder %}
                    <span class="note-folder-badge">{{ note.folder.name }}</span>
                  {% endif %}
                  <span class="note-archived-badge">{% translate "Archived" %}</span>
                </div>
                  <span class="note-meta">
                    {{ note.created_at|date:"M d, Y H:i" }}
                    {% if note.author %}· {{ note.author.get_username }}{% endif %}
                  </span>
                </header>
                <div class="note-body">{{ note.body|linebreaksbr }}</div>
                {% if note.images.all %}
                  <div class="note-image-grid">
                    {% for image in note.images.all %}
                      <button
                        type="button"
                        class="note-image-btn"
                        data-full="https://drive.google.com/uc?export=view&id={{ image.drive_file_id }}"
                        data-caption="{{ image.filename|default:'Note image' }}"
                        title="Click to zoom"
                      >
                        <span class="note-image-tile">
                          <img
                            src="https://drive.google.com/thumbnail?id={{ image.drive_file_id }}&sz=w800"
                            alt="{{ image.filename|default:'Note image' }}"
                            loading="lazy"
                          />
                        </span>
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="note-card-actions">
                  <form method="post" class="note-action-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="unarchive" />
                    <input type="hidden" name="note_id" value="{{ note.id }}" />
                    <input type="hidden" name="next" value="{{ request.path }}" />
                    <button
                      type="submit"
                      class="default"
                      onclick="event.stopPropagation();"
                      title="Restore this note"
                    >
                      Restore
                    </button>
                  </form>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </div>

  <dialog id="note-image-lightbox" class="note-lightbox">
    <div class="note-lightbox-head">
      <span id="note-lightbox-caption"></span>
      <button type="button" class="button" id="note-lightbox-close">Close</button>
    </div>
    <div class="note-lightbox-body">
      <img id="note-lightbox-image" alt="Note image zoom" />
    </div>
  </dialog>

  <dialog id="note-detail-dialog" class="note-detail-dialog">
    <div class="note-detail-head">
      <span>Note</span>
      <button type="button" class="button" id="note-detail-close">Close</button>
    </div>
    <div class="note-detail-body" id="note-detail-body"></div>
  </dialog>

  <script>
    (function () {
      const fileInput = document.getElementById("note-images-input");
      const zone = document.getElementById("note-paste-zone");
      const browse = document.getElementById("note-images-browse");
      const previewList = document.getElementById("note-image-preview-list");
      if (fileInput) {
        fileInput.hidden = true;
      }

      const renderPreviews = () => {
        if (!previewList || !fileInput) return;
        previewList.innerHTML = "";
        Array.from(fileInput.files || []).forEach((file) => {
          const item = document.createElement("div");
          item.className = "note-image-preview-item";
          const tile = document.createElement("div");
          tile.className = "note-image-preview-tile";
          const img = document.createElement("img");
          img.alt = file.name || "Pasted image";
          img.src = URL.createObjectURL(file);
          img.onload = () => URL.revokeObjectURL(img.src);
          tile.appendChild(img);
          const label = document.createElement("div");
          label.className = "note-image-preview-label";
          label.textContent = file.name || "pasted-image";
          item.appendChild(tile);
          item.appendChild(label);
          previewList.appendChild(item);
        });
      };

      const appendFiles = (incoming) => {
        if (!fileInput || !incoming || !incoming.length) return;
        const dt = new DataTransfer();
        Array.from(fileInput.files || []).forEach((f) => dt.items.add(f));
        Array.from(incoming).forEach((file) => {
          if ((file.type || "").startsWith("image/")) {
            dt.items.add(file);
          }
        });
        fileInput.files = dt.files;
        renderPreviews();
      };

      if (fileInput) {
        fileInput.addEventListener("change", renderPreviews);
      }
      if (browse && fileInput) {
        browse.addEventListener("click", () => fileInput.click());
      }
      if (zone) {
        zone.addEventListener("paste", (event) => {
          const items = Array.from(event.clipboardData?.items || []);
          const images = items
            .filter((item) => item.kind === "file" && item.type.startsWith("image/"))
            .map((item) => item.getAsFile())
            .filter(Boolean);
          if (images.length) {
            event.preventDefault();
            appendFiles(images);
          }
        });
        zone.addEventListener("dragover", (event) => {
          event.preventDefault();
          zone.classList.add("is-dragover");
        });
        zone.addEventListener("dragleave", () => zone.classList.remove("is-dragover"));
        zone.addEventListener("drop", (event) => {
          event.preventDefault();
          zone.classList.remove("is-dragover");
          appendFiles(Array.from(event.dataTransfer?.files || []));
        });
      }
      document.addEventListener("paste", (event) => {
        if (!fileInput) return;
        const target = event.target;
        if (target && target.closest && target.closest("#admin-note-form")) {
          return;
        }
        const items = Array.from(event.clipboardData?.items || []);
        const images = items
          .filter((item) => item.kind === "file" && item.type.startsWith("image/"))
          .map((item) => item.getAsFile())
          .filter(Boolean);
        if (images.length) {
          appendFiles(images);
        }
      });

      const notesList = document.querySelector(".notes-list");
      const detailDialog = document.getElementById("note-detail-dialog");
      const detailBody = document.getElementById("note-detail-body");
      const detailClose = document.getElementById("note-detail-close");
      const lightbox = document.getElementById("note-image-lightbox");
      const lightboxImage = document.getElementById("note-lightbox-image");
      const lightboxCaption = document.getElementById("note-lightbox-caption");
      const closeBtn = document.getElementById("note-lightbox-close");
      const openNoteDialog = (card) => {
        if (!detailDialog || !detailBody || !card) return;
        const content = card.querySelector(".note-card-content");
        if (!content) return;
        detailBody.innerHTML = content.innerHTML;
        detailDialog.showModal();
      };

      if (notesList) {
        notesList.addEventListener("click", (event) => {
          const imageButton = event.target.closest(".note-image-btn");
          if (imageButton) {
            if (!lightbox || !lightboxImage) return;
            lightboxImage.src = imageButton.dataset.full || "";
            if (lightboxCaption) lightboxCaption.textContent = imageButton.dataset.caption || "";
            lightbox.showModal();
            return;
          }
          const card = event.target.closest(".note-card-clickable");
          if (!card) return;
          openNoteDialog(card);
        });
        notesList.addEventListener("keydown", (event) => {
          if (event.key !== "Enter" && event.key !== " ") return;
          const card = event.target.closest(".note-card-clickable");
          if (!card) return;
          event.preventDefault();
          openNoteDialog(card);
        });
      }
      if (closeBtn && lightbox) {
        closeBtn.addEventListener("click", () => lightbox.close());
      }
      if (lightbox) {
        lightbox.addEventListener("click", (event) => {
          const rect = lightbox.getBoundingClientRect();
          const inside =
            event.clientX >= rect.left &&
            event.clientX <= rect.right &&
            event.clientY >= rect.top &&
            event.clientY <= rect.bottom;
          if (!inside) {
            lightbox.close();
          }
        });
      }
      if (detailClose && detailDialog) {
        detailClose.addEventListener("click", () => detailDialog.close());
      }
      if (detailDialog) {
        detailDialog.addEventListener("click", (event) => {
          const rect = detailDialog.getBoundingClientRect();
          const inside =
            event.clientX >= rect.left &&
            event.clientX <= rect.right &&
            event.clientY >= rect.top &&
            event.clientY <= rect.bottom;
          if (!inside) {
            detailDialog.close();
          }
        });
      }
    })();
  </script>
{% endblock %}
